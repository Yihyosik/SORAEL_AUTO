<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>소라엘 채팅</title>
<style>
    :root {
        --bg: #f5f6f8;
        --user: #4f8df5;
        --ai: #ffffff;
        --ai-text: #222;
    }
    @media (prefers-color-scheme: dark) {
        :root {
            --bg: #1c1c1e;
            --user: #4f8df5;
            --ai: #2c2c2e;
            --ai-text: #f5f5f7;
        }
    }
    body {
        margin: 0;
        background: var(--bg);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    #chat {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        scroll-behavior: smooth;
    }
    .msg {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.4;
        animation: fadeIn 0.3s ease-out forwards;
        word-break: break-word;
    }
    .user {
        background: var(--user);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
        animation: slideUser 0.3s ease-out;
    }
    .ai {
        background: var(--ai);
        color: var(--ai-text);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        animation: slideAI 0.3s ease-out;
    }
    #input-area {
        display: flex;
        padding: 12px;
        background: var(--ai);
        border-top: 1px solid #ddd;
    }
    #input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 16px;
        outline: none;
        background: var(--bg);
        color: var(--ai-text);
    }
    #send {
        margin-left: 8px;
        padding: 0 16px;
        background: var(--user);
        color: white;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        cursor: pointer;
    }
    #send:active {
        transform: scale(0.97);
    }
    .typing {
        display: inline-block;
    }
    .dot {
        height: 6px;
        width: 6px;
        background: #bbb;
        border-radius: 50%;
        display: inline-block;
        animation: blink 1.4s infinite both;
        margin: 0 1px;
    }
    .dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    .dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    @keyframes blink {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.3; }
        40% { transform: scale(1); opacity: 1; }
    }
    @keyframes slideUser {
        from { transform: translateX(30px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideAI {
        from { transform: translateX(-30px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
</head>
<body>
<div id="chat"></div>
<div id="input-area">
    <input id="input" type="text" placeholder="메시지를 입력하세요..." />
    <button id="send">전송</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

async function loadHistory() {
    const res = await fetch('/api/history');
    const history = await res.json();
    history.forEach(msg => addMessage(msg.role, msg.content));
}

function addMessage(sender, text) {
    const div = document.createElement('div');
    div.className = `msg ${sender}`;
    div.innerHTML = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function typeMessage(text) {
    return new Promise(resolve => {
        const div = document.createElement('div');
        div.className = `msg ai`;
        chat.appendChild(div);
        let i = 0;
        const interval = setInterval(() => {
            div.innerHTML = text.slice(0, i++);
            chat.scrollTop = chat.scrollHeight;
            if (i > text.length) {
                clearInterval(interval);
                resolve();
            }
        }, 20);
    });
}

function showTyping() {
    const div = document.createElement('div');
    div.className = 'msg ai typing';
    div.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
}

async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    addMessage('user', text);
    input.value = '';

    const typingDiv = showTyping();

    const res = await fetch('/api/dialogue', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
    });
    const data = await res.json();

    typingDiv.remove();
    await typeMessage(data.response);
}

sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

document.addEventListener('DOMContentLoaded', loadHistory);
</script>
</body>
</html>